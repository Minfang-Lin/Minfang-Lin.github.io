<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Geekband C++面向对象高级编程 第四周作业 · 叶卡林娜的部落格</title><meta name="description" content="Geekband C++面向对象高级编程 第四周作业 - Minfang Lin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://leavesite.com/atom.xml" title="叶卡林娜的部落格"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Minfang-Lin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Geekband C++面向对象高级编程 第四周作业</h1><div class="post-info">Feb 8, 2016</div><div class="post-content"><h2 id="题目说明："><a href="#题目说明：" class="headerlink" title="题目说明："></a>题目说明：</h2><p>分别给出下面的类型Fruit和Apple的类型大小（即对象size），并通过画出二者对象模型的方式来解释该size的构成原因。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> &#123;</span></div><div class="line">  <span class="keyword">int</span> no;</div><div class="line">  <span class="keyword">double</span> weight;</div><div class="line">  <span class="keyword">char</span> key;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;;</div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span>:</span> <span class="keyword">public</span> Fruit &#123;</div><div class="line">  <span class="keyword">int</span> size;</div><div class="line">  <span class="keyword">char</span> type;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h2><p>注：析构函数设置为虚函数并不影响sizeof结果，只是在vtbl里面多增加一项。<br>观察这道题目主要有两点需要考虑。第一，当类里面存在虚函数时，这个类所占的内存就会比没有虚函数时候大一点，大的位置是在类的成员变量前面会多出一个指针（vptr），它指向虚指针表（vtbl），虚指针表里面的每一个指针再指向对应的虚函数。从而实现动态绑定；第二，在C语言介绍struct时，就说过一点，大多数计算机，数据项要求从某个数量字节的倍数开始存放，如short从偶数地址开始，int则被对齐在4字节边界。为了满足内存对齐，在比较小的成员后面会加入补位。在用不同的操作系统和编译器时也发现了，sizeof的结果有所不同，所以这道题目并没有正确的答案，说明所使用的操作系统和某种编译器下的情形就可以了。首先画出<s>对象模型图</s>示意图：<br><img src="\images\Class Diagram.png" alt="Class Diagram.png"><br><s>因为我不会画UML类图，</s>大概就是这个意思，<s>虚函数表的指针（vptr）在内存中会出现在其他所有成员之前</s>，C++语言规范明确定义了内存上的成员变量的顺序和代码定义时的顺序是一致的（为了保证与C语言兼容）。正因为存在这样的顺序，所以在初始化子类的时候，会先初始化父类的成员变量，再初始化子类的。对象切割（Object Slicing）也可以顺利进行。</p>
<p>vptr的位置在规范中没有确定。当然我们可以去测试一下看看vptr到底在什么位置。测试代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> &#123;</span></div><div class="line">  <span class="keyword">int</span> no = <span class="number">10</span>;</div><div class="line">  <span class="keyword">double</span> weight;</div><div class="line">  <span class="keyword">char</span> key;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span>:</span> <span class="keyword">public</span> Fruit &#123;</div><div class="line">  <span class="keyword">int</span> size;</div><div class="line">  <span class="keyword">char</span> type;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line">  Fruit f1, f2;</div><div class="line">  Apple a1;</div><div class="line"></div><div class="line">  <span class="keyword">int</span>* pf1 = (<span class="keyword">int</span>*) &amp;f1;</div><div class="line">  <span class="keyword">int</span>* pf2 = (<span class="keyword">int</span>*) &amp;f2;</div><div class="line">  <span class="keyword">int</span>* hpf1 = (<span class="keyword">int</span>*) *pf1;</div><div class="line">  <span class="keyword">int</span>* hpf2 = (<span class="keyword">int</span>*) *pf2;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; *pf1 &lt;&lt; <span class="built_in">endl</span> &lt;&lt; *(pf1 + <span class="number">1</span>) &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; *pf2 &lt;&lt; <span class="built_in">endl</span> &lt;&lt; *(pf2 + <span class="number">1</span>) &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; hpf1 &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">  <span class="keyword">int</span>* pa1 = (<span class="keyword">int</span>*) &amp;a1;</div><div class="line">  <span class="keyword">int</span>* hpa1 = (<span class="keyword">int</span>*) *pa1;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; hpa1 &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>在32位下编译（因为32位指针和int都占4个字节）。</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 某次运行结果</span></div><div class="line">4780872</div><div class="line">10</div><div class="line">4780872</div><div class="line">10</div><div class="line">0x48f348</div><div class="line">0x48f338</div></pre></td></tr></table></figure>
<p>这里我将no写了个默认值是10，通过打印f1、f2对象第一个位置的值，发现第一项是vptr，第二项才是no。而且Fruit和Apple类具有各自不同的vptr。（TDM-GCC以及LLVM(Clang)都是vptr在最前面）。</p>
<p>通过把所有成员设置为公有成员输出地址，或者调试的方法，可以测出在内存分布情况。测试代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keyword">int</span> no;</div><div class="line">  <span class="keyword">double</span> weight;</div><div class="line">  <span class="keyword">char</span> key;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span>:</span> <span class="keyword">public</span> Fruit &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keyword">int</span> size;</div><div class="line">  <span class="keyword">char</span> type;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"sizeof(Fruit) = "</span> &lt;&lt; <span class="keyword">sizeof</span>(Fruit) &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"sizeof(Apple) = "</span> &lt;&lt; <span class="keyword">sizeof</span>(Apple) &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">  Fruit fruit;</div><div class="line">  Apple apple;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Fruit        = %x\n"</span>, &amp;fruit);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Fruit.no     = %x\n"</span>, &amp;fruit.no);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Fruit.weight = %x\n"</span>, &amp;fruit.weight);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Fruit.key    = %x\n"</span>, &amp;fruit.key);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Apple        = %x\n"</span>, &amp;apple);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Apple.no     = %x\n"</span>, &amp;apple.no);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Apple.weight = %x\n"</span>, &amp;apple.weight);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Apple.key    = %x\n"</span>, &amp;apple.key);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Apple.size   = %x\n"</span>, &amp;apple.size);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Apple.type   = %x\n"</span>, &amp;apple.type);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Windows 10 TDM-GCC 4.9.2 64-bit 某次运行结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">sizeof(Fruit) = 32</div><div class="line">sizeof(Apple) = 40</div><div class="line">Fruit        = 9ffe00</div><div class="line">Fruit.no     = 9ffe08</div><div class="line">Fruit.weight = 9ffe10</div><div class="line">Fruit.key    = 9ffe18</div><div class="line">Apple        = 9ffe20</div><div class="line">Apple.no     = 9ffe28</div><div class="line">Apple.weight = 9ffe30</div><div class="line">Apple.key    = 9ffe38</div><div class="line">Apple.size   = 9ffe3c</div><div class="line">Apple.type   = 9ffe40</div></pre></td></tr></table></figure>
<p>Mac OS X 10.11.3 LLVM version 7.0.2 (clang-700.1.81) 64-bit 某次运行结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">sizeof(Fruit) = 32</div><div class="line">sizeof(Apple) = 40</div><div class="line">Fruit        = 50960c50</div><div class="line">Fruit.no     = 50960c58</div><div class="line">Fruit.weight = 50960c60</div><div class="line">Fruit.key    = 50960c68</div><div class="line">Apple        = 50960c28</div><div class="line">Apple.no     = 50960c30</div><div class="line">Apple.weight = 50960c38</div><div class="line">Apple.key    = 50960c40</div><div class="line">Apple.size   = 50960c44</div><div class="line">Apple.type   = 50960c48</div></pre></td></tr></table></figure>
<p>对应内存图：<br><img src="\images\gcc64bit.png" alt="gcc64bit.png"></p>
<p>64位和32位的区别在于指针的大小，64位是8个字节，32位是4个字节。而当我使用不同的编译器时，32位呈现出的排布也有所不同。<br>Windows 10 TDM-GCC 4.9.2 32-bit 某次运行结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">sizeof(Fruit) = 24</div><div class="line">sizeof(Apple) = 32</div><div class="line">Fruit        = 6dfe88</div><div class="line">Fruit.no     = 6dfe8c</div><div class="line">Fruit.weight = 6dfe90</div><div class="line">Fruit.key    = 6dfe98</div><div class="line">Apple        = 6dfe68</div><div class="line">Apple.no     = 6dfe6c</div><div class="line">Apple.weight = 6dfe70</div><div class="line">Apple.key    = 6dfe78</div><div class="line">Apple.size   = 6dfe7c</div><div class="line">Apple.type   = 6dfe80</div></pre></td></tr></table></figure>
<p>对应内存图<br><img src="\images\gcc32bit.png" alt="gcc32bit.png"></p>
<p>Mac OS X 10.11.3 LLVM version 7.0.2 (clang-700.1.81) 32-bit 某次运行结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">sizeof(Fruit) = 20</div><div class="line">sizeof(Apple) = 28</div><div class="line">Fruit        = bff79c30</div><div class="line">Fruit.no     = bff79c34</div><div class="line">Fruit.weight = bff79c38</div><div class="line">Fruit.key    = bff79c40</div><div class="line">Apple        = bff79c10</div><div class="line">Apple.no     = bff79c14</div><div class="line">Apple.weight = bff79c18</div><div class="line">Apple.key    = bff79c20</div><div class="line">Apple.size   = bff79c24</div><div class="line">Apple.type   = bff79c28</div></pre></td></tr></table></figure>
<p>对应内存图<br><img src="\images\llvm32bit.png" alt="llvm32bit.png"><br>不管是stack还是heap建立的对象，以sizeof所求得的值都是相同的。</p>
<p>猜想：以结果来看，似乎GCC是以最宽的数据作为基始值倍数增加的，而LLVM在32位下是4，所以最后并没有将4字节补位，造成两个编译器的结果不同。<br>对于以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></div><div class="line">  <span class="keyword">char</span> c1;</div><div class="line">  <span class="keyword">double</span> d1;</div><div class="line">  <span class="keyword">char</span> c2;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"sizeof(A) = "</span> &lt;&lt; <span class="keyword">sizeof</span>(A) &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>32位下GCC结果为24，LLVM结果为16。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/Geekband-CPP-Homework-W5/" class="prev">PREV</a><a href="/2016/Geekband-CPP-Homework-W3/" class="next">NEXT</a></div><div data-thread-key="2016/Geekband-CPP-Homework-W4/" data-title="Geekband C++面向对象高级编程 第四周作业" data-url="http://leavesite.com/2016/Geekband-CPP-Homework-W4/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"leavesite"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2013 - 2017 <a href="http://leavesite.com">Minfang Lin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>