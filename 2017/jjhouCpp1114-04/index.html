<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> C++ 新标准 11/14 标准库新部件 - 01 · 叶卡林娜的部落格</title><meta name="description" content="C++ 新标准 11/14 标准库新部件 - 01 - Minfang Lin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://leavesite.com/atom.xml" title="叶卡林娜的部落格"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Minfang-Lin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">C++ 新标准 11/14 标准库新部件 - 01</h1><div class="post-info">Jan 29, 2017</div><div class="post-content"><h2 id="Rvalue-references"><a href="#Rvalue-references" class="headerlink" title="Rvalue references"></a>Rvalue references</h2><p>右值引用是C++03出现的一种新的引用类型，用于解决不必要的copy。当赋值的右边（拷贝来源端）是一个右值（rvalue），那么左边（拷贝接受端）的对象可以不重新分配内存，而直接“偷”右边对象的内容（这种情形只有在指针的情况下才会发生）。</p>
<ul>
<li>Lvalue：可以出现于operator=左侧者，如变量</li>
<li>Rvalue：只能出现于operator=右侧者，如临时对象</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 以int试验</span></div><div class="line"><span class="keyword">int</span> a = <span class="number">9</span>;</div><div class="line"><span class="keyword">int</span> b = <span class="number">4</span>;</div><div class="line"></div><div class="line">a = b;   <span class="comment">// ok</span></div><div class="line">b = a;   <span class="comment">// ok</span></div><div class="line">a = a+b; <span class="comment">// ok</span></div><div class="line"></div><div class="line">a + b = <span class="number">42</span>; <span class="comment">// Error: lvalue required as left operand of assignment</span></div></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 以string试验</span></div><div class="line"><span class="function"><span class="built_in">string</span> <span class="title">s1</span><span class="params">(<span class="string">"Hello"</span>)</span></span>;</div><div class="line"><span class="function"><span class="built_in">string</span> <span class="title">s2</span><span class="params">(<span class="string">"World"</span>)</span></span>;</div><div class="line">s1 + s2 = s2;                  <span class="comment">// ok, s1+s2可以当做lvalue</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"s1: "</span> &lt;&lt; s1 &lt;&lt; <span class="built_in">endl</span>;  <span class="comment">// s1: Hello</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"s2: "</span> &lt;&lt; s2 &lt;&lt; <span class="built_in">endl</span>;  <span class="comment">// s2: World</span></div><div class="line"><span class="built_in">string</span>() = <span class="string">"World"</span>;            <span class="comment">// ok, 居然可以对临时对象赋值</span></div></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 以complex试验</span></div><div class="line"><span class="keyword">complex</span>&lt;<span class="keyword">int</span>&gt; c1(<span class="number">3</span>,<span class="number">8</span>), c2(<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">c1 + c2 = <span class="keyword">complex</span>&lt;<span class="keyword">int</span>&gt;(<span class="number">4</span>,<span class="number">9</span>);         <span class="comment">// ok, c1+c2可以当做lvalue</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"c1: "</span> &lt;&lt; c1 &lt;&lt; <span class="built_in">endl</span>;        <span class="comment">// c1:(3,8)</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"c2: "</span> &lt;&lt; c2 &lt;&lt; <span class="built_in">endl</span>;        <span class="comment">// c2:(1,0)</span></div><div class="line"><span class="keyword">complex</span>&lt;<span class="keyword">int</span>&gt;() = <span class="keyword">complex</span>&lt;<span class="keyword">int</span>&gt;(<span class="number">4</span>,<span class="number">9</span>);  <span class="comment">// ok, 居然可以对临时对象赋值</span></div></pre></td></tr></table></figure>
<p>C++本身的一些class/type会引来一些对于赋值动作不可预见的情况，如前面的string和complex，而造成定义的不正确（临时对象是rvalue）。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">5</span>; &#125;</div><div class="line"><span class="keyword">int</span> x = foo();    <span class="comment">// ok</span></div><div class="line"><span class="keyword">int</span>* p = &amp;foo();  <span class="comment">// Error: 不能对rvalue取其地址</span></div><div class="line">foo() = <span class="number">7</span>;        <span class="comment">// Error</span></div></pre></td></tr></table></figure>
<p>函数的返回值是rvalue，对rvalue取地址是不允许的。</p>
<p>对于临时对象（rvalue），可以通过右值引用（&amp;&amp;）避免重新分配内存创建对象；而对于lvalue，可以通过调用move()函数实现，但必须确保这个对象之后不会再被使用。</p>
<h2 id="Perfect-Forwarding"><a href="#Perfect-Forwarding" class="headerlink" title="Perfect Forwarding"></a>Perfect Forwarding</h2><p>所谓完美的传递，指的是在多级函数调用的过程中，参数的属性（可变的还是const的，lvalue还是rvalue）也能够被传递。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">int</span>&amp; i)</span> </span>&#123;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"process(int&amp;):"</span> &lt;&lt; i &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">int</span>&amp;&amp; i)</span> </span>&#123;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"process(int&amp;&amp;):"</span> &lt;&lt; i &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">forward</span><span class="params">(<span class="keyword">int</span>&amp;&amp; i)</span> </span>&#123;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"forward(int&amp;&amp;):"</span> &lt;&lt; i &lt;&lt; <span class="string">", "</span>;</div><div class="line">  process(i);</div><div class="line">&#125;</div><div class="line"></div><div class="line">     <span class="keyword">int</span> a = <span class="number">0</span>;</div><div class="line">     process(a);        <span class="comment">// process(int&amp;):0</span></div><div class="line">                        <span class="comment">// 视为lvalue处理</span></div><div class="line">                        </div><div class="line">     process(<span class="number">1</span>);        <span class="comment">// process（int&amp;&amp;）：1 </span></div><div class="line">                        <span class="comment">// 临时对象视为rvalue处理</span></div><div class="line">                        </div><div class="line">     process(move(a));  <span class="comment">// process(int&amp;&amp;):0 </span></div><div class="line">                        <span class="comment">// 强制将lvalue改为rvalue</span></div><div class="line">                        </div><div class="line">     forward(<span class="number">2</span>);        <span class="comment">// forward(int&amp;&amp;):2, process(int&amp;):2</span></div><div class="line">                        <span class="comment">// rvalue经由forward()传给另一个函数后却变为lvalue</span></div><div class="line">                        <span class="comment">// （原因是在传递过程中把它变为了非临时对象）</span></div><div class="line">                        </div><div class="line">     forward(move(a));  <span class="comment">// forward(int&amp;&amp;):0, process(int&amp;):0</span></div><div class="line">     </div><div class="line"><span class="comment">//!  forward(a);        // Error: cannot bind 'int' lvalue to 'int&amp;&amp;'</span></div><div class="line"></div><div class="line">     <span class="keyword">const</span> <span class="keyword">int</span> &amp;b = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">//!  process(b);        // Error: no matching function for call 'process(const int&amp;)</span></div><div class="line"></div><div class="line"><span class="comment">//!  process(move(b));  // Error: no matching function for call to</span></div><div class="line">                        <span class="comment">// 'process(std::remove_rederence&lt;const int&amp;&gt;::type)'</span></div><div class="line"></div><div class="line"><span class="comment">//!  int&amp; x(5);         // Error: invaild initialization of non-const reference of</span></div><div class="line">                        <span class="comment">// tyoe 'int&amp;' from an rvalue of type 'int'</span></div></pre></td></tr></table></figure>
<p>显然目前的写法并不能实现属性传递。所以标准库里面做move的操作之前会调用forward()，借用下面这段代码的设计完成完美的传递。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ...\4.9.2\include\c++\bits\move.h</span></div><div class="line"></div><div class="line"><span class="comment">//  @brief  Forward an lvalue.</span></div><div class="line"><span class="comment">//  @return The parameter cast to the specified type.</span></div><div class="line"><span class="comment">//  This function is used to implement "perfect forwarding".</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</div><div class="line">  <span class="keyword">constexpr</span> _Tp&amp;&amp;</div><div class="line">  forward(<span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp; <span class="keyword">__t</span>) <span class="keyword">noexcept</span></div><div class="line">  &#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="keyword">__t</span>); &#125;</div><div class="line"></div><div class="line"><span class="comment">//  @brief  Forward an rvalue.</span></div><div class="line"><span class="comment">//  @return The parameter cast to the specified type.</span></div><div class="line"><span class="comment">//  This function is used to implement "perfect forwarding".</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</div><div class="line">  <span class="keyword">constexpr</span> _Tp&amp;&amp;</div><div class="line">  forward(<span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp;&amp; <span class="keyword">__t</span>) <span class="keyword">noexcept</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">static_assert</span>(!<span class="built_in">std</span>::is_lvalue_reference&lt;_Tp&gt;::value, <span class="string">"template argument"</span></div><div class="line">    <span class="string">" substituting _Tp is an lvalue reference type"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="keyword">__t</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">//  @brief  Convert a value to an rvalue.</span></div><div class="line"><span class="comment">//  @param  __t  A thing of arbitrary type.</span></div><div class="line"><span class="comment">//  @return The parameter cast to an rvalue-reference to allow moving it.</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</div><div class="line">  <span class="keyword">constexpr</span> <span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp;&amp;</div><div class="line">  move(_Tp&amp;&amp; <span class="keyword">__t</span>) <span class="keyword">noexcept</span></div><div class="line">  &#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp;&amp;&gt;(<span class="keyword">__t</span>); &#125;</div></pre></td></tr></table></figure>
<h2 id="设计一个带有move的class"><a href="#设计一个带有move的class" class="headerlink" title="设计一个带有move的class"></a>设计一个带有move的class</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyString</span> &#123;</span> </div><div class="line"><span class="keyword">private</span>: </div><div class="line">  <span class="keyword">char</span>* _data; </div><div class="line">  <span class="keyword">size_t</span> _len; </div><div class="line">  <span class="keyword">void</span> _init_data(<span class="keyword">const</span> <span class="keyword">char</span> *s) &#123; </div><div class="line">      _data = <span class="keyword">new</span> <span class="keyword">char</span>[_len+<span class="number">1</span>]; </div><div class="line">      <span class="built_in">memcpy</span>(_data, s, _len); </div><div class="line">      _data[_len] = <span class="string">'\0'</span>; </div><div class="line">  &#125; </div><div class="line"><span class="keyword">public</span>: </div><div class="line">  <span class="comment">// default ctor</span></div><div class="line">  MyString() : _data(<span class="literal">NULL</span>), _len(<span class="number">0</span>) &#123;  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// ctor</span></div><div class="line">  MyString(<span class="keyword">const</span> <span class="keyword">char</span>* p) : _len(<span class="built_in">strlen</span>(p)) &#123; </div><div class="line">    _init_data(p); </div><div class="line">  &#125; </div><div class="line"></div><div class="line">  <span class="comment">// copy ctor</span></div><div class="line">  MyString(<span class="keyword">const</span> MyString&amp; str) : _len(str._len) &#123; </div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Copy Constructor is called! source: "</span> &lt;&lt; str._data </div><div class="line">         &lt;&lt; <span class="string">" ["</span> &lt;&lt; (<span class="keyword">void</span>*)(str._data) &lt;&lt; <span class="string">']'</span> &lt;&lt; <span class="built_in">endl</span>;   	</div><div class="line">    _init_data(str._data); 	<span class="comment">// COPY</span></div><div class="line">  &#125; </div><div class="line"></div><div class="line">  <span class="comment">// move ctor, with "noexcept"</span></div><div class="line">  MyString(MyString&amp;&amp; str) <span class="keyword">noexcept</span> : _data(str._data), _len(str._len) &#123;  </div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Move Constructor is called! source: "</span> &lt;&lt; str._data </div><div class="line">         &lt;&lt; <span class="string">" ["</span> &lt;&lt; (<span class="keyword">void</span>*)(str._data) &lt;&lt; <span class="string">']'</span> &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">    str._len = <span class="number">0</span>; 		</div><div class="line">    str._data = <span class="literal">NULL</span>;   <span class="comment">// 这句很重要!!!</span></div><div class="line">                        <span class="comment">// 另外需要避免 delete (in dtor)，不然会把临时对象杀掉  </span></div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  <span class="comment">// copy assignment</span></div><div class="line">  MyString&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> MyString&amp; str) &#123; </div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Copy Assignment is called! source: "</span> &lt;&lt; str._data </div><div class="line">         &lt;&lt; <span class="string">" ["</span> &lt;&lt; (<span class="keyword">void</span>*)(str._data) &lt;&lt; <span class="string">']'</span> &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;str) &#123; </div><div class="line">      <span class="keyword">if</span> (_data) <span class="keyword">delete</span> _data;  </div><div class="line">      _len = str._len; </div><div class="line">      _init_data(str._data); 	<span class="comment">// COPY! </span></div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">      <span class="built_in">cout</span> &lt;&lt; <span class="string">"Self Assignment, Nothing to do."</span> &lt;&lt; <span class="built_in">endl</span>;   </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>; </div><div class="line">  &#125; </div><div class="line"></div><div class="line">  <span class="comment">// move assignment</span></div><div class="line">  MyString&amp; <span class="keyword">operator</span>=(MyString&amp;&amp; str) <span class="keyword">noexcept</span> &#123; </div><div class="line">    <span class="comment">// 注意 noexcept </span></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Move Assignment is called! source: "</span> &lt;&lt; str._data </div><div class="line">         &lt;&lt; <span class="string">" ["</span> &lt;&lt; (<span class="keyword">void</span>*)(str._data) &lt;&lt; <span class="string">']'</span> &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;str) &#123; </div><div class="line">      <span class="keyword">if</span> (_data) <span class="keyword">delete</span> _data; </div><div class="line">      _len = str._len; </div><div class="line">      _data = str._data;	<span class="comment">// MOVE!</span></div><div class="line">      str._len = <span class="number">0</span>; </div><div class="line">      str._data = <span class="literal">NULL</span>; 	<span class="comment">// 这句很重要!!!</span></div><div class="line">                          <span class="comment">// 另外需要避免 delete (in dtor)，不然会把临时对象杀掉 </span></div><div class="line">    &#125; </div><div class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>; </div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  <span class="comment">// dtor</span></div><div class="line">  <span class="keyword">virtual</span> ~MyString() &#123; 	</div><div class="line">  <span class="comment">// 文档说需 noexcept 但本处无. destructor is noexcept by default.</span></div><div class="line">  <span class="comment">// Johan Lundberg Mar 18 '13 at 12:12    </span></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Destructor is called! "</span> &lt;&lt; <span class="string">"source: "</span>; </div><div class="line">    <span class="keyword">if</span> (_data)</div><div class="line">      <span class="built_in">cout</span> &lt;&lt; _data; </div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">" ["</span> &lt;&lt; (<span class="keyword">void</span>*)(_data) &lt;&lt; <span class="string">']'</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (_data) &#123;</div><div class="line">      <span class="keyword">delete</span> _data; 	</div><div class="line">    &#125;</div><div class="line">  &#125;   	</div><div class="line">&#125;;</div></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2017/web-security-01/" class="prev">PREV</a><a href="/2017/jjhouCpp1114-03/" class="next">NEXT</a></div><div data-thread-key="2017/jjhouCpp1114-04/" data-title="C++ 新标准 11/14 标准库新部件 - 01" data-url="http://leavesite.com/2017/jjhouCpp1114-04/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"leavesite"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2013 - 2017 <a href="http://leavesite.com">Minfang Lin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>